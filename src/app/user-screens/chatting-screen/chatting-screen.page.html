<ion-header [translucent]="true">
  <ion-toolbar>

    <ng-container *ngIf="selectedMessages.length > 0; else defaultHeader">
      <ion-title>{{ selectedMessages.length }} selected</ion-title>
      <ion-buttons slot="end">

        <!-- âœ… Only 1 Text Message -->
        <ng-container *ngIf="isOnlyOneTextMessage()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="copySelectedMessages()">
            <ion-icon name="copy-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="replyToMessages()">
            <ion-icon name="return-up-back-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="onMore($event)">
            <ion-icon name="ellipsis-vertical-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- âœ… Multiple Text Messages -->
        <ng-container *ngIf="isMultipleTextMessages()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="copySelectedMessages()">
            <ion-icon name="copy-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- âœ… Only 1 Attachment -->
        <ng-container *ngIf="isOnlyOneAttachment()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="replyToMessages()">
            <ion-icon name="return-up-back-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="onMore($event)">
            <ion-icon name="ellipsis-vertical-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- âœ… Multiple Attachments -->
        <ng-container *ngIf="isMultipleAttachments()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- âœ… Mixed: text + attachment -->
        <ng-container *ngIf="isMixedSelection()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ng-container>

      </ion-buttons>
    </ng-container>


    <!-- ðŸ” Default Chat Header -->
    <ng-template #defaultHeader>
      <ion-buttons *ngIf="!showSearchBar" slot="start" style="color: black; width: 8%; margin-top: 15px;">
        <ion-back-button defaultHref="/home-screen"></ion-back-button>
      </ion-buttons>

      <ng-container *ngIf="!showSearchBar; else searchBar">
        <ion-buttons>
          <ion-item lines="none" style="--padding-start: 0; --background: white; color: black; margin-top: 15px;"
            detail="false">
            <ion-avatar slot="start">
              <img src="assets/images/user.jfif" alt="User Avatar"
                onError="this.src='assets/images/default-avatar.png'" />
            </ion-avatar>
            <ion-label (click)="goToProfile()"
              style="width: auto; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer;">
              <h2 style="margin: 0; font-size: 16px;">
                {{ chatType === 'group' ? groupName : receiver_name }}
              </h2>
            </ion-label>
          </ion-item>
        </ion-buttons>
      </ng-container>

      <ng-template #searchBar>
        <ion-item lines="none"
          style="margin-top: 10px; padding: 10px 15px; --border-radius: 25px; --background: #f5f5f5; width: 100%;">
          <ion-icon name="arrow-back-outline" slot="start" style="font-size: 24px; cursor: pointer; margin-right: 10px;"
            (click)="cancelSearch()"></ion-icon>
          <ion-input placeholder="Search messages..." [(ngModel)]="searchText" (ionInput)="onSearchInput()"
            style="margin-left: 10px; flex: 1;">
          </ion-input>
          <ion-buttons slot="end">
            <ion-button (click)="openDatePicker()">
              <ion-icon name="calendar-outline"></ion-icon>
            </ion-button>
            <ion-button (click)="navigateSearch('up')">
              <ion-icon name="arrow-up-outline"></ion-icon>
            </ion-button>
            <ion-button (click)="navigateSearch('down')">
              <ion-icon name="arrow-down-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-item>
      </ng-template>

      <ion-buttons *ngIf="!showSearchBar" slot="end" style="margin-top: 15px;">
        <ion-button style="color: black;">
          <ion-icon name="videocam-outline" style="font-size: 35px;"></ion-icon>
        </ion-button>
        <ion-button (click)="goToCallingScreen()" style="color: black;">
          <ion-icon name="call-outline" style="font-size: 28px;"></ion-icon>
        </ion-button>
        <ion-button (click)="openOptions($event)" style="color: black;">
          <ion-icon name="ellipsis-vertical-outline" style="font-size: 28px;"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ng-template>

  </ion-toolbar>
</ion-header>


<ion-content class="chat-background" [fullscreen]="true" [scrollEvents]="true">
  
  <!-- Pinned Message Banner (Alternative/Mobile View) -->
  <div *ngIf="pinnedMessage && pinnedMessageDetails && showMobilePinnedBanner" class="pinned-message-banner" 
       (click)="scrollToPinnedMessage()">
    <div class="pinned-content">
      <div class="pinned-header">
        <ion-icon name="pin" class="pin-icon"></ion-icon>
        <span class="pinned-text">Pinned Message</span>
        <ion-icon name="close" class="unpin-icon" (click)="unpinMessage(); $event.stopPropagation()"></ion-icon>
      </div>
      <div class="pinned-message-preview">
        <span class="pinned-sender" *ngIf="chatType === 'group'">{{ pinnedMessageDetails.sender_name }}:</span>
        
        <!-- Text message preview -->
        <span *ngIf="pinnedMessageDetails.text && !pinnedMessageDetails.attachment" class="pinned-text-content">
          {{ pinnedMessageDetails.text.length > 50 ? (pinnedMessageDetails.text | slice:0:50) + '...' : pinnedMessageDetails.text }}
        </span>
        
        <!-- Attachment preview -->
        <span *ngIf="pinnedMessageDetails.attachment" class="pinned-attachment">
          <ion-icon [name]="getAttachmentIcon(pinnedMessageDetails.attachment.type)"></ion-icon>
          {{ getAttachmentPreview(pinnedMessageDetails.attachment) }}
        </span>
      </div>
    </div>
  </div>

  <div #scrollContainer class="chat-messages" 
       style="padding: 10px 10px 80px 10px; overflow-y: auto; min-height: 100%;">
    
    <ion-spinner name="dots" *ngIf="isLoadingMore" style="margin: 8px auto; display: block;"></ion-spinner>

    <div *ngFor="let group of groupedMessages">
      <div class="date-divider" [id]="'date-group-' + group.date">
        <div class="text-bg-white date-label">{{ group.date }}</div>
      </div>

      <div *ngFor="let msg of group.messages" [ngClass]="{
       'align-end': msg.sender_id === senderId,
       'align-start': msg.sender_id !== senderId,
       'selected': isSelected(msg),
       'pinned-message-highlight': pinnedMessage && pinnedMessage.messageId === msg.message_id
     }" style="display: flex; flex-direction: column; margin: 5px 0;" 
        (touchstart)="startLongPress(msg)"
        (touchend)="cancelLongPress()" 
        (touchmove)="cancelLongPress()" 
        (click)="onMessageClick(msg)">

        <div class="message-bubble" (click)="openAttachmentModal(msg)" [attr.data-msg-key]="msg.key"
          [ngClass]="msg.sender_id === senderId ? 'sender-message' : 'receiver-message'">

            <div *ngIf="msg.isForwarded" class="forwarded-label">
    <ion-icon name="arrow-undo-outline" class="forwarded-icon"></ion-icon>
    Forwarded
  </div>

          <!-- Checkbox for selected messages -->
          <!-- <ion-icon *ngIf="selectedMessages.length > 0" [name]="isSelected(msg) ? 'checkbox' : 'square-outline'"
            style="margin-bottom: 5px; font-size: 20px;">
          </ion-icon> -->

          <!-- Sender name for group chat -->
          <span *ngIf="chatType === 'group' && msg.sender_id !== senderId"
            style="font-size: 12px; color: #6c6c6c; margin-left: 5px;">
            {{ msg.sender_name }}
          </span>

          <!-- REPLIED MESSAGE DISPLAY -->
          <div class="replied-message" *ngIf="msg.replyToMessageId"
            (click)="scrollToRepliedMessage(msg.replyToMessageId)">
            <ng-container *ngIf="getRepliedMessage(msg.replyToMessageId) as repliedMsg">
              <div class="replied-header">
                <ion-icon name="arrow-undo-outline" class="reply-icon"></ion-icon>
                <span class="replied-sender">{{ repliedMsg.sender_name }}</span>
              </div>
              <div class="replied-content">
                <div class="replied-text" *ngIf="repliedMsg.text">
                  {{ getReplyPreviewText(repliedMsg) }}
                </div>
                <div class="replied-attachment" *ngIf="repliedMsg.attachment">
                  <ion-icon name="attach-outline"></ion-icon>
                  {{ getReplyPreviewText(repliedMsg) }}
                </div>
              </div>
            </ng-container>
          </div>

          <!-- Show deleted message placeholder -->
          <ng-container *ngIf="msg.isDeleted">
            <ion-text class="message-text" color="medium"><i>This message was deleted</i></ion-text>
          </ng-container>

          <!-- Show normal message if not deleted -->
          <ng-container *ngIf="!msg.isDeleted">
            <!-- Text Message -->
            <ion-text class="message-text" *ngIf="!msg.attachment && msg.text">{{ msg.text }}</ion-text>

            <!-- Attachments -->
            <ng-container *ngIf="msg.attachment">
              <!-- Image -->
              <img *ngIf="msg.attachment.type === 'image'" [src]="msg.attachment.base64Data" alt="Image"
                style="max-width: 200px; border-radius: 10px; margin: 5px 0;" />

              <!-- Video -->
              <video *ngIf="msg.attachment.type === 'video'" controls
                style="max-width: 200px; border-radius: 10px; margin: 5px 0;">
                <source [src]="msg.attachment.base64Data" [type]="msg.attachment.mimeType || 'video/mp4'" />
                Your browser does not support the video tag.
              </video>

              <!-- Audio -->
              <audio *ngIf="msg.attachment.type === 'audio'" controls style="margin: 5px 0;">
                <source [src]="msg.attachment.base64Data" [type]="msg.attachment.mimeType || 'audio/mpeg'" />
                Your browser does not support the audio element.
              </audio>

              <!-- File -->
              <div *ngIf="msg.attachment.type === 'file'" style="margin: 5px 0;">
                <ion-icon name="document-outline" style="margin-right: 5px;"></ion-icon>
                <a [href]="msg.attachment.base64Data" [download]="msg.attachment.fileName || 'file'" target="_blank"
                  rel="noopener">
                  {{ msg.attachment.fileName || 'Download File' }}
                </a>
              </div>

              <!-- Optional Caption -->
              <ion-text class="message-text" *ngIf="msg.attachment.caption">{{ msg.attachment.caption }}</ion-text>
            </ng-container>
          </ng-container>

          <!-- Timestamp & Status -->
          <p class="time-stamp status-container">
            <!-- Pin indicator in timestamp -->
            <ion-icon *ngIf="pinnedMessage && pinnedMessage.messageId === msg.message_id" 
                      name="pin" class="pin-indicator-timestamp"></ion-icon>
            {{ msg.time }}
            <ng-container *ngIf="msg.sender_id === senderId">
              <ion-icon *ngIf="!msg.delivered" name="checkmark-outline" class="status-icon sent"></ion-icon>
              <ion-icon *ngIf="msg.delivered && !msg.read" name="checkmark-done-outline"
                class="status-icon delivered"></ion-icon>
              <ion-icon *ngIf="msg.delivered && msg.read" name="checkmark-done-outline"
                class="status-icon read"></ion-icon>
            </ng-container>
          </p>
        </div>
      </div>
    </div>
  </div>
</ion-content>

<ion-modal [isOpen]="showPreviewModal" (didDismiss)="showPreviewModal = false">
  <ng-template>
    <ion-header translucent>
      <ion-toolbar>
        <ion-title>Preview Attachment</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cancelAttachment()">Cancel</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <div class="pre-model">
        <div class="mine2">

          <div *ngIf="selectedAttachment?.type === 'image'">
            <img [src]="selectedAttachment?.base64" class="preview-image" />
          </div>

          <div *ngIf="selectedAttachment?.type === 'video'">
            <video controls [src]="selectedAttachment?.base64" class="preview-video"></video>
          </div>

          <div *ngIf="selectedAttachment?.type === 'file'" class="preview-file">
            <ion-icon name="document-attach-outline" style="font-size: 48px"></ion-icon>
            <p>{{ selectedAttachment?.fileName }}</p>
          </div>

        </div>

        <div class="mine">

          <ion-textarea [(ngModel)]="messageText" placeholder="Type your message here..."
            class="pre-message"></ion-textarea>

          <div class="sendbtn">
            <p>user name</p>
            <ion-icon name="send-outline" (click)="sendMessage()" class="mediasend"></ion-icon>
          </div>

        </div>

      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- âœ… Message Input Footer -->
<div class="footer-fixed">

  <!-- REPLY PREVIEW - Add this section -->
  <div class="reply-preview" *ngIf="replyToMessage">
    <div class="reply-header">
      <span class="reply-to-text">Replying to {{ replyToMessage.sender_name }}</span>
      <ion-button fill="clear" size="small" (click)="cancelReply()">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </div>
    <div class="reply-content">
      <div class="reply-line"></div>
      <div class="reply-message">
        {{ getReplyPreviewText(replyToMessage) }}
      </div>
    </div>
  </div>


  <ion-row class="footer-row">
    <ion-col class="message-input-container">
      <!-- <ion-icon name="document-text-outline" class="icon-left"></ion-icon> -->
      <ion-icon name="document-text-outline" class="icon-left" (click)="openKeyboard()">
      </ion-icon>
      <ion-textarea [autoGrow]="true" [(ngModel)]="messageText" placeholder="Message" (ionInput)="onInputChange()"
        (ionFocus)="onInputFocus()" (ionBlur)="onInputBlur()" (keyup.enter)="sendMessage()"
        class="message-input"></ion-textarea>

      <!-- <ion-textarea [(ngModel)]="messageText" placeholder="Type your message here..." class="pre-message"></ion-textarea> -->

      <!-- Attachment Icon -->
      <!-- <ion-icon name="attach-outline" class="icon-right"></ion-icon> -->

      <!-- Attachment Icon -->
      <!-- <ion-icon
  name="attach-outline"
  class="icon-right"
  (click)="selectAttachment()"
></ion-icon> -->

      <!-- <ion-button fill="clear" (click)="pickAttachment()"> -->
      <ion-icon name="attach-outline" (click)="pickAttachment()" class="icon-right"></ion-icon>
      <!-- </ion-button> -->

      <!-- Show attachment -->
      <!-- <ion-list *ngIf="attachment.length > 0">
  <ion-item *ngFor="let att of attachment">
    <ion-thumbnail slot="start" *ngIf="att.type === 'image'">
      <img [src]="att.filePath" />
    </ion-thumbnail>
    <ion-label>
      <p>{{ att.type }} - {{ att.createdAt | date:'short' }}</p>
    </ion-label>
  </ion-item>
</ion-list> -->

      <!-- <div *ngFor="let message of messages">
    <div *ngIf="message.type === 'image'">
      <img [src]="message.url" style="max-width: 200px;" />
    </div>
    <div *ngIf="message.type === 'text'">{{ message.text }}</div>
  </div> -->

      <!-- <ion-list *ngIf="attachment.length > 0">
        <ion-item *ngFor="let att of attachment">
          <ion-thumbnail slot="start" *ngIf="att.type === 'image'">
            <img [src]="att.filePath" />
          </ion-thumbnail>
          <ion-label>
            <p>{{ att.type }} - {{ att.createdAt | date:'short' }}</p>
          </ion-label>
        </ion-item>
      </ion-list> -->

      <ion-icon name="camera-outline" class="icon-right" (click)="openCamera()"></ion-icon>
    </ion-col>

    <ion-col size="auto">
      <ion-button *ngIf="!showSendButton" class="mic-button" shape="round">
        <ion-icon slot="icon-only" name="mic"></ion-icon>
      </ion-button>
      <ion-button *ngIf="showSendButton" fill="clear" class="send-btn" shape="round" (click)="sendMessage()">
        <ion-icon slot="icon-only" name="send"></ion-icon>
      </ion-button>
    </ion-col>
  </ion-row>
</div>

<ion-modal [isOpen]="showDateModal" (didDismiss)="showDateModal = false">
  <ng-template>
    <ion-content>
      <ion-datetime presentation="date" [showDefaultButtons]="true" (ionChange)="onDateSelected($event)">
      </ion-datetime>
    </ion-content>
  </ng-template>
</ion-modal>