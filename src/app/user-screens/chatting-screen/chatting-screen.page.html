<ion-header class="chat-header" [translucent]="true">
  <ion-toolbar>

    <ng-container *ngIf="selectedMessages.length > 0; else defaultHeader">
      <ion-title>{{ selectedMessages.length }} selected</ion-title>
      <ion-buttons slot="end">

        <!-- ✅ Only 1 Text Message -->
        <ng-container *ngIf="isOnlyOneTextMessage()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="copySelectedMessages()">
            <ion-icon name="copy-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="replyToMessages()">
            <ion-icon name="return-up-back-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="onMore($event)">
            <ion-icon name="ellipsis-vertical-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- ✅ Multiple Text Messages -->
        <ng-container *ngIf="isMultipleTextMessages()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="copySelectedMessages()">
            <ion-icon name="copy-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- ✅ Only 1 Attachment -->
        <ng-container *ngIf="isOnlyOneAttachment()">
          <ion-button (click)="replyToMessages()">
            <ion-icon name="return-up-back-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="onMore($event)">
            <ion-icon name="ellipsis-vertical-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- ✅ Multiple Attachments -->
        <ng-container *ngIf="isMultipleAttachments()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- ✅ Mixed: text + attachment -->
        <ng-container *ngIf="isMixedSelection()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ng-container>

      </ion-buttons>
    </ng-container>


    <!-- 🔁 Default Chat Header -->
    <ng-template #defaultHeader>
      <ion-buttons *ngIf="!showSearchBar" slot="start" style="color: black; width: 8%; margin-top: 15px;">
        <ion-back-button defaultHref="/home-screen"></ion-back-button>
        <!-- <ion-icon name="arrow-back-outline" class="back-icon"></ion-icon> -->
      </ion-buttons>

      <ng-container *ngIf="!showSearchBar; else searchBar">
        <ion-buttons>
          <ion-item lines="none" style="--padding-start: 0; --background: white; color: black; margin-top: 15px;"
            detail="false">
            <!-- <ion-avatar slot="start">
              <img src="assets/images/user.jfif" alt="User Avatar"
                onError="this.src='assets/images/default-avatar.png'" />
            </ion-avatar> -->
            <ion-avatar style="margin-left: 10px;" slot="start">
              <img [src]="currentConv?.avatar || 'assets/images/default-avatar.png'" alt="User Avatar"
                (error)="setDefaultAvatar($event)" />
              <!-- <img [src]="currentChat.avatar || 'assets/images/default-avatar.png'" alt="User Avatar"
                (error)="setDefaultAvatar($event)" /> -->
            </ion-avatar>
            <ion-label (click)="goToProfile()"
              style="width: auto; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer;">
              <!-- <h2 style="margin: 0; font-size: 16px;">
              </h2> -->
              <h2>{{ currentConv?.title||"Chat title" }}</h2>

              <!-- ---- Presence (Online / Last seen) ---- -->
              <div
                style="font-size:12px; color: var(--ion-color-medium); margin-top:4px; display:flex; align-items:center; gap:8px;">

                <ng-container *ngIf="receiverOnline; else lastSeenTpl">
                  <span class="online-dot" aria-hidden="true"></span>
                  <span>Online</span>
                </ng-container>

                <ng-template #lastSeenTpl>
                  <div class="last-seen-scroll">
                    <span *ngIf="receiverLastSeen">Last seen {{ receiverLastSeen }}</span>
                  </div>
                </ng-template>
              </div>


              <!-- ---- Typing indicator (kept as-is, will show only when typingCount > 0) ---- -->
              <div class="chat-status" *ngIf="typingCount > 0"
                style="font-size:12px; color: var(--ion-color-medium); margin-top:4px;">
                <!-- Private Chat -->
                <ng-container *ngIf="chatType === 'private'">
                  {{ receiver_name }} is typing...
                </ng-container>

                <!-- Group Chat -->
                <ng-container *ngIf="chatType === 'group'">
                  {{ typingCount }} people are typing...
                </ng-container>
              </div>
            </ion-label>

          </ion-item>
        </ion-buttons>
      </ng-container>

      <ng-template #searchBar>
        <ion-item lines="none"
          style="margin-top: 10px; padding: 10px 15px; --border-radius: 25px; --background: #f5f5f5; width: 100%;">
          <ion-icon name="arrow-back-outline" slot="start" style="font-size: 24px; cursor: pointer; margin-right: 10px;"
            (click)="cancelSearch()"></ion-icon>
          <ion-input placeholder="Search messages..." [(ngModel)]="searchText" (ionInput)="onSearchInput()"
            style="margin-left: 10px; flex: 1;">
          </ion-input>
          <ion-buttons slot="end">
            <!-- <ion-button (click)="openDatePicker()">
            <ion-icon name="calendar-outline"></ion-icon>
          </ion-button> -->
            <ion-button (click)="openPopover($event)">
              <ion-icon name="calendar-outline"></ion-icon>
            </ion-button>
            <ion-button (click)="navigateSearch('up')">
              <ion-icon name="arrow-up-outline"></ion-icon>
            </ion-button>
            <ion-button (click)="navigateSearch('down')">
              <ion-icon name="arrow-down-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-item>
      </ng-template>

      <ion-buttons *ngIf="!showSearchBar" slot="end" style="margin-top: 15px;">
        <ion-button style="color: black;">
          <ion-icon name="videocam-outline" style="font-size: 35px;"></ion-icon>
        </ion-button>
        <ion-button (click)="goToCallingScreen()" style="color: black;">
          <ion-icon name="call-outline" style="font-size: 28px;"></ion-icon>
        </ion-button>
        <ion-button (click)="openOptions($event)" style="color: black;">
          <ion-icon name="ellipsis-vertical-outline" style="font-size: 28px;"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ng-template>

  </ion-toolbar>
</ion-header>

<!-- BLOCK BANNERS -->
<!-- <div *ngIf="chatType === 'private'">
  <div *ngIf="iBlocked" class="blocked-banner" style="padding:8px; text-align:center; background:#fff3f3; color:#b00020;">
    You have blocked {{ receiver_name }}. Messages won't be sent.
    <button ion-button (click)="unblockFromChat()" style="margin-left:8px; border:none; background:transparent; color: #0a66ff;">Unblock</button>
  </div>

  <div *ngIf="!iBlocked && theyBlocked" class="blocked-banner" style="padding:8px; text-align:center; background:#fff7e6; color:#b36b00;">
    You cannot send messages to {{ receiver_name }} — they have blocked you.
  </div>
</div> -->



<ion-content class="chat-background" [fullscreen]="true" [scrollEvents]="true">

  <!-- Pinned Message Banner (Alternative/Mobile View) -->
  <div *ngIf="pinnedMessage && pinnedMessageDetails && showMobilePinnedBanner" class="pinned-message-banner"
    (click)="scrollToPinnedMessage()">
    <div class="pinned-content">
      <div class="pinned-header">
        <ion-icon name="pin" class="pin-icon"></ion-icon>
        <span class="pinned-text">Pinned Message</span>
        <ion-icon name="close" class="unpin-icon" (click)="unpinMessage(); $event.stopPropagation()"></ion-icon>
      </div>
      <div class="pinned-message-preview">
        <span class="pinned-sender" *ngIf="chatType === 'group'">{{ pinnedMessageDetails.sender_name }}:</span>

        <!-- Text message preview -->
        <span *ngIf="pinnedMessageDetails.text && !pinnedMessageDetails.attachment" class="pinned-text-content">
          {{ pinnedMessageDetails.text.length > 50 ? (pinnedMessageDetails.text | slice:0:50) + '...' :
          pinnedMessageDetails.text }}
        </span>

        <!-- Attachment preview -->
        <span *ngIf="pinnedMessageDetails.attachment" class="pinned-attachment">
          <ion-icon [name]="getAttachmentIcon(pinnedMessageDetails.attachment.type)"></ion-icon>
          {{ getAttachmentPreview(pinnedMessageDetails.attachment) }}
        </span>
      </div>
    </div>
  </div>

  <div #scrollContainer class="chat-messages" style="padding: 10px 10px 10px 10px; overflow-y: auto; min-height: 100%;">

    <!-- System block/unblock bubbles (only visible to blocker) -->
    <div *ngIf="showBlockBubble" class="system-bubble-wrapper"
      style="display:flex; justify-content:center; margin:10px 0;">
      <div class="system-bubble" (click)="unblockFromChat()">
        You blocked this contact. Tap to unblock.
      </div>
    </div>

    <div *ngIf="showUnblockBubble" class="system-bubble-wrapper"
      style="display:flex; justify-content:center; margin:10px 0;">
      <div class="system-bubble system-bubble-success">
        You unblocked this contact.
      </div>
    </div>

    <ion-spinner name="dots" *ngIf="isLoadingMore" style="margin: 8px auto; display: block;"></ion-spinner>

    <div *ngFor="let group of groupedMessages">
      <div class="date-divider" [id]="'date-group-' + group.date">
        <div class="text-bg-white date-label">{{ group.date }}</div>
      </div>

      <div *ngFor="let msg of group.messages" class="msg-row" [ngClass]="{
       'align-end': msg.sender_id === senderId,
       'align-start': msg.sender_id !== senderId,
       'selected': isSelected(msg),
       'pinned-message-highlight': pinnedMessage && pinnedMessage.messageId === msg.message_id
     }" style="display: flex; flex-direction: column; margin: 5px 0;" (touchstart)="startLongPress(msg)"
        (touchend)="cancelLongPress()" (touchmove)="cancelLongPress()" (click)="onMessageClick(msg)">

        <!-- ===== MESSAGE BUBBLE ===== -->
        <div class="message-bubble" (click)="openAttachmentModal(msg)" [attr.data-msg-key]="msg.key" [ngClass]="[
        msg.isMe ? 'sender-message' : 'receiver-message',
       ]">

          <!-- Forwarded Label -->
          <div *ngIf="msg.isForwarded" class="forwarded-label">
            <ion-icon name="arrow-undo-outline" class="forwarded-icon"></ion-icon>
            Forwarded
          </div>

          <!-- Group Sender Name -->
          <span *ngIf="chatType === 'group' && msg.sender_id !== senderId"
            style="font-size: 12px; color: #6c6c6c; margin-left: 5px;">
            {{ msg.sender_name }}
          </span>

          <!-- Replied Message -->
          <div class="replied-message" *ngIf="msg.replyToMessageId"
            (click)="scrollToRepliedMessage(msg.replyToMessageId)">
            <ng-container *ngIf="msg.replyToMessageId && getRepliedMessage(msg.replyToMessageId) as repliedMsg">
              <div class="replied-header">
                <ion-icon name="arrow-undo-outline" class="reply-icon"></ion-icon>
                <!-- <span class="replied-sender">{{ repliedMsg.sender_name }}</span> -->
              </div>
              <div class="replied-content">
                <div class="replied-text" *ngIf="repliedMsg.text">
                  {{ getReplyPreviewText(repliedMsg) }}
                </div>
                <div class="replied-attachment" *ngIf="repliedMsg.attachment">
                  <ion-icon name="attach-outline"></ion-icon>
                  {{ getReplyPreviewText(repliedMsg) }}
                </div>
              </div>
            </ng-container>
          </div>

          <!-- Deleted Message -->
          <ng-container *ngIf="msg.isDeleted">
            <ion-text class="message-text" color="medium"><i>This message was deleted</i></ion-text>
          </ng-container>

          <!-- Normal Message -->
          <ng-container *ngIf="!msg.isDeleted">
            <ion-text class="message-text" *ngIf="!msg.attachment && msg.text">{{ msg.text }}</ion-text>

            <!-- Attachments -->
            <ng-container *ngIf="msg.attachment">
              <img *ngIf="msg.attachment.type === 'image'" [src]="msg.attachment.previewUrl" alt="Image"
                style="max-width: 200px; border-radius: 10px; margin: 5px 0;" />
              <video *ngIf="msg.attachment.type === 'video'" controls
                style="max-width: 200px; border-radius: 10px; margin: 5px 0;">
                <source [src]="msg.attachment.previewUrl" [type]="msg.attachment.mimeType || 'video/mp4'" />
              </video>
              <audio *ngIf="msg.attachment.type === 'audio'" controls style="margin: 5px 0;">
                <source [src]="msg.attachment.previewUrl" [type]="msg.attachment.mimeType || 'audio/mpeg'" />
              </audio>
              <div *ngIf="msg.attachment.type === 'file'" style="margin: 5px 0;">
                <ion-icon name="document-outline" style="margin-right: 5px;"></ion-icon>
                <a [href]="msg.attachment.previewUrl" [download]="msg.attachment.fileName || 'file'" target="_blank"
                  rel="noopener">
                  {{ msg.attachment.fileName || 'Download File' }}
                </a>
              </div>
              <ion-text class="message-text" *ngIf="msg.text" style="margin-top: 5px;">
                {{ msg.text }}
              </ion-text>
              <!-- <ion-text class="message-text" *ngIf="msg.attachment.caption">
          {{ msg.attachment.caption }}
        </ion-text> -->
            </ng-container>
          </ng-container>

          <!-- Timestamp -->
          <p class="time-stamp status-container">
            <ion-icon *ngIf="pinnedMessage && pinnedMessage.messageId === msg.message_id" name="pin"
              class="pin-indicator-timestamp"></ion-icon>
            {{ msg.time }}
            <span *ngIf="msg.isEdit" style="font-size: 11px; color: gray; margin-left: 4px;">(edited)</span>
            <ng-container *ngIf="msg.sender_id === senderId">
              <ion-icon *ngIf="!msg.delivered" name="checkmark-outline" class="status-icon sent"></ion-icon>
              <ion-icon *ngIf="msg.delivered && !msg.read" name="checkmark-done-outline"
                class="status-icon delivered"></ion-icon>
              <ion-icon *ngIf="msg.delivered && msg.read" name="checkmark-done-outline"
                class="status-icon read"></ion-icon>
            </ng-container>
          </p>

          <!-- 🟡 COMPACT REACTION BADGE (WhatsApp style) -->
          <div class="reaction-badges" *ngIf="getReactionBadges(msg).length > 0"
            [class.right]="msg.sender_id === senderId" [class.left]="msg.sender_id !== senderId">
            <!-- <div class="badge"
           *ngFor="let b of getReactionBadges(msg)"
           [class.mine]="b.mine"
           (click)="addReaction(msg, b.emoji)">
        <span class="emoji">{{ b.emoji }}</span>
        <span class="cnt" *ngIf="b.count > 1">{{ b.count }}</span>
      </div> -->
            <div class="badge" *ngFor="let b of getReactionBadges(msg)" [class.mine]="b.mine"
              (click)="onReactionBadgeClick($event, msg, b)">
              <span class="emoji">{{ b.emoji }}</span>
              <span class="cnt" *ngIf="b.count > 1">{{ b.count }}</span>
            </div>
          </div>

        </div>

        <!-- 🟢 FLOATING REACTION BAR -->
        <div class="reaction-bar" *ngIf="isQuickReactionOpen(msg)" [class.right]="msg.sender_id === senderId"
          [class.left]="msg.sender_id !== senderId">
          <!-- <button class="react-btn" (click)="addReaction(msg, '👍')">👍</button>
      <button class="react-btn" (click)="addReaction(msg, '❤️')">❤️</button>
      <button class="react-btn" (click)="addReaction(msg, '😂')">😂</button>
      <button class="react-btn" (click)="addReaction(msg, '😮')">😮</button>
      <button class="react-btn" (click)="addReaction(msg, '😢')">😢</button>
      <button class="react-btn" (click)="addReaction(msg, '🙏')">🙏</button>
      <button class="react-btn more" (click)="openEmojiKeyboard(msg)">＋</button> -->
        </div>


      </div>



    </div>
  </div>
</ion-content>


<ion-modal [isOpen]="showPreviewModal" (didDismiss)="showPreviewModal = false">
  <ng-template>
    <ion-header [translucent]="true" class="model-header">
      <ion-toolbar class="model-toll">
        <ion-buttons slot="start">
          <!-- <ion-button (click)="cancelAttachment()">Cancel</ion-button> -->
          <ion-icon (click)="cancelAttachment()" name="close" style="font-size: 25px"></ion-icon>
        </ion-buttons>

        <ion-buttons slot="end" class="pre-icons">
          <img src="assets/images/hd.png" alt="hd" />
          <ion-icon name="happy-outline" style="font-size: 24px"></ion-icon>
          <img src="assets/images/text.png" alt="text" />
          <img src="assets/images/pencil.png" alt="pencil" />
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="">
      <div class="pre-model">
        <div class="mine2">
          <div *ngIf="selectedAttachment?.type === 'image'">
            <img [src]="selectedAttachment?.previewUrl" class="preview-image" />
          </div>

          <div *ngIf="selectedAttachment?.type === 'video'">
            <video controls [src]="selectedAttachment?.previewUrl" class="preview-video"></video>
          </div>

          <div *ngIf="selectedAttachment?.type === 'file'" class="preview-file">
            <ion-icon name="document-attach-outline" style="font-size: 48px"></ion-icon>
            <p>{{ selectedAttachment?.fileName }}</p>
          </div>
        </div>

        <div class="mine ion-padding">
          <ion-textarea [(ngModel)]="messageText" placeholder="Type your message here..."
            class="pre-message"></ion-textarea>

          <div class="sendbtn">
            <p>{{ receiver_name }}</p>
            <!-- <ion-icon
              name="send-outline"
              (click)="sendMessage()"
              class="mediasend"
            ></ion-icon> -->

            <ion-icon name="send-outline" (click)="sendMessage()" class="mediasend" [class.sending]="isSending"
              [style.pointer-events]="isSending ? 'none' : 'auto'" [style.opacity]="isSending ? '0.5' : '1'">
            </ion-icon>

          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>


<!-- ✅ Message Input Footer -->
<!-- ========================= -->
<!-- Message Input Footer (updated) -->
<div class="footer-fixed">

  <!-- If current user has blocked the contact, show action footer -->
  <!-- <div *ngIf="iBlocked" class="blocked-action-footer"
    style="display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:#fff; border-top:1px solid #eee;">
    <button (click)="deleteChat()"
      style="display:flex; align-items:center; gap:8px; border:none; background:transparent; color:#d32f2f; font-weight:600;">
      <ion-icon name="trash-outline"></ion-icon>
      Delete chat
    </button>

    <button (click)="unblockFromChat()"
      style="display:flex; align-items:center; gap:8px; border:none; background:transparent; color:#138000; font-weight:600;">
      <ion-icon name="ban-outline"></ion-icon>
      Unblock
    </button>
  </div> -->

  <!-- Normal footer: typing indicator, reply preview, input row -->
  <div *ngIf="!iBlocked">

    <!-- Typing indicator (above keyboard) -->
    <div class="typing-indicator-wrapper" *ngIf="typingCount > 0">
      <!-- GROUP layout -->
      <div *ngIf="chatType === 'group'" class="typing-indicator-content group">
        <div class="typing-text">
          <div class="typing-avatars">
            <ng-container *ngIf="typingCount === 1 && typingUsers.length >= 1">
              <img class="typing-avatar single" [src]="typingUsers[0].avatar" (error)="setDefaultAvatar($event)"
                [alt]="typingUsers[0].name || 'User'">
            </ng-container>
            <ng-container *ngIf="typingCount >= 2">
              <div class="avatar-stack">
                <img *ngFor="let u of typingUsers.slice(0,3); let i = index" class="typing-avatar stacked idx-{{i}}"
                  [src]="u.avatar" (error)="setDefaultAvatar($event)" [alt]="u.name || 'User'">
                <div class="more-badge" *ngIf="typingCount > 3">+{{ typingCount - 3 }}</div>
              </div>
            </ng-container>
          </div>
        </div>

        <div class="typing-dots" aria-hidden="true" role="status" aria-label="typing">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
      </div>

      <!-- PRIVATE layout -->
      <div *ngIf="chatType === 'private'" class="typing-indicator-content private">
        <div class="typing-dots center-only" aria-hidden="true" role="status" aria-label="typing">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
      </div>
    </div>
    <!-- ========================= -->

    <!-- REPLY PREVIEW -->
    <div class="reply-preview" *ngIf="replyToMessage">
      <div class="reply-header">
        <span class="reply-to-text">Replying to {{ replyToMessage.sender_name }}</span>
        <ion-button fill="clear" size="small" (click)="cancelReply()">
          <ion-icon name="close" slot="icon-only"></ion-icon>
        </ion-button>
      </div>
      <div class="reply-content">
        <div class="reply-line"></div>
        <div class="reply-message">{{ getReplyPreviewText(replyToMessage) }}</div>
      </div>
    </div>

    <!-- INPUT ROW -->
    <ion-row class="footer-row" style="align-items:center;">
      <ion-col class="message-input-container" style="display:flex; align-items:center; gap:8px;">
        <ion-icon name="document-text-outline" class="icon-left" (click)="openKeyboard()"></ion-icon>

        <ion-textarea [disabled]="iBlocked" [autoGrow]="true" [(ngModel)]="messageText" placeholder="Message"
          (ionInput)="onInputTyping()" (ionFocus)="onInputFocus()" (ionBlur)="onInputBlur()"
          (keyup.enter)="sendMessage()" class="message-input">
        </ion-textarea>

        <ion-icon name="attach-outline" (click)="pickAttachment()" class="icon-right" [hidden]="iBlocked"></ion-icon>
        <ion-icon name="camera-outline" class="icon-right" (click)="openCamera()" [hidden]="iBlocked"></ion-icon>
      </ion-col>

      <ion-col size="auto" style="display:flex; align-items:center;">
        <ion-button *ngIf="!showSendButton" class="mic-button" shape="round" [disabled]="iBlocked">
          <ion-icon slot="icon-only" name="mic"></ion-icon>
        </ion-button>

        <ion-button *ngIf="showSendButton" fill="clear" class="send-btn" shape="round" (click)="sendMessage()"
          [disabled]="iBlocked">
          <ion-icon slot="icon-only" name="send"></ion-icon>
        </ion-button>
      </ion-col>
    </ion-row>
  </div>
</div>
<!-- ========================= -->


<ion-popover [isOpen]="showPopover" [event]="popoverEvent" (didDismiss)="showPopover = false"
  style="--width: 300px; --height: 400px">
  <ng-template>
    <ion-datetime presentation="date" (ionChange)="onDateSelected($event)" [value]="selectedDate"
      showDefaultButtons="true"></ion-datetime>
  </ng-template>
</ion-popover>