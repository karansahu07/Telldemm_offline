<ion-header class="chat-header" [translucent]="true">
  <ion-toolbar>
    <ng-container *ngIf="selectedMessages.length > 0; else defaultHeader">
      <ion-title>{{ selectedMessages.length }} selected</ion-title>
      <ion-buttons slot="end">
        <!-- ✅ Only 1 Text Message -->
        <ng-container *ngIf="isOnlyOneTextMessage()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="copySelectedMessages()">
            <ion-icon name="copy-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="replyToMessages()">
            <ion-icon name="return-up-back-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="onMore($event)">
            <ion-icon name="ellipsis-vertical-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- ✅ Multiple Text Messages -->
        <ng-container *ngIf="isMultipleTextMessages()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="copySelectedMessages()">
            <ion-icon name="copy-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- ✅ Only 1 Attachment -->
        <ng-container *ngIf="isOnlyOneAttachment()">
          <ion-button (click)="replyToMessages()">
            <ion-icon name="return-up-back-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="onMore($event)">
            <ion-icon name="ellipsis-vertical-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- ✅ Multiple Attachments -->
        <ng-container *ngIf="isMultipleAttachments()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <!-- ✅ Mixed: text + attachment -->
        <ng-container *ngIf="isMixedSelection()">
          <ion-button (click)="onForward()">
            <ion-icon name="arrow-redo-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="deleteSelectedMessages()">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ng-container>
      </ion-buttons>
    </ng-container>

    <!-- 🔁 Default Chat Header -->
    <ng-template #defaultHeader>
      <ion-buttons
        *ngIf="!showSearchBar"
        slot="start"
        style="color: black; width: 8%; margin-top: 15px"
      >
        <ion-back-button (click)="onBack()"></ion-back-button>
        <!-- <ion-icon name="arrow-back-outline" class="back-icon"></ion-icon> -->
      </ion-buttons>

      <ng-container *ngIf="!showSearchBar; else searchBar">
        <ion-buttons>
          <ion-item
            lines="none"
            style="
              --padding-start: 0;
              --background: white;
              color: black;
              margin-top: 15px;
            "
            detail="false"
          >
            <ion-avatar style="margin-left: 10px" slot="start">
              <img
                [src]="currentConv?.avatar || 'assets/images/default-avatar.png'"
                alt="User Avatar"
                (error)="setDefaultAvatar($event)"
              />
            </ion-avatar>
            <ion-label
              (click)="goToProfile()"
              style="
                width: auto;
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                cursor: pointer;
              "
            >
              <h2>{{ currentConv?.title||"Chat title" }}</h2>

              <!-- ---- Presence & Typing Status ---- -->
              <div
                style="
                  font-size: 12px;
                  margin-top: 4px;
                  display: flex;
                  align-items: center;
                  gap: 4px;
                "
              >
                <!-- Private Chat -->
                <ng-container *ngIf="currentConv?.type === 'private'">
                  <!-- 🆕 Show typing first if user is typing -->
                  <ng-container *ngIf="isReceiverTyping; else presenceBlock">
                    <span style="color: var(--ion-color-success)"
                      >typing...</span
                    >
                  </ng-container>

                  <!-- Otherwise show online/last seen -->
                  <ng-template #presenceBlock>
                    <ng-container
                      *ngIf="receiverStatus === 'online'; else lastSeenTpl"
                    >
                      <span class="online-dot" aria-hidden="true"></span>
                      <span style="color: var(--ion-color-success)"
                        >Online</span
                      >
                    </ng-container>

                    <ng-template #lastSeenTpl>
                      <span
                        style="color: var(--ion-color-medium)"
                        *ngIf="lastSeenTime"
                      >
                        {{ lastSeenTime }}
                      </span>
                    </ng-template>
                  </ng-template>
                </ng-container>

                <!-- Group Chat -->
                <ng-container *ngIf="currentConv?.type === 'group'">
                  <!-- 🆕 Show typing count if anyone is typing -->
                  <ng-container
                    *ngIf="typingCount > 0; else groupPresenceBlock"
                  >
                    <span style="color: var(--ion-color-success)">
                      {{ typingCount }} {{ typingCount === 1 ? 'person' :
                      'people' }} typing...
                    </span>
                  </ng-container>

                  <!-- Otherwise show member count -->
                  <ng-template #groupPresenceBlock>
                    <span style="color: var(--ion-color-medium)">
                      {{ currentConv?.members?.length || 0 }} members
                    </span>
                  </ng-template>
                </ng-container>
              </div>
            </ion-label>
          </ion-item>
        </ion-buttons>
      </ng-container>

      <ng-template #searchBar>
        <ion-item
          lines="none"
          style="
            margin-top: 10px;
            padding: 10px 15px;
            --border-radius: 25px;
            --background: #f5f5f5;
            width: 100%;
          "
        >
          <ion-icon
            name="arrow-back-outline"
            slot="start"
            style="font-size: 24px; cursor: pointer; margin-right: 10px"
            (click)="cancelSearch()"
          ></ion-icon>
          <ion-input
            placeholder="Search messages..."
            [(ngModel)]="searchText"
            (ionInput)="onSearchInput()"
            style="margin-left: 10px; flex: 1"
          >
          </ion-input>
          <ion-buttons slot="end">
            <!-- <ion-button (click)="openDatePicker()">
            <ion-icon name="calendar-outline"></ion-icon>
          </ion-button> -->
            <ion-button (click)="openPopover($event)">
              <ion-icon name="calendar-outline"></ion-icon>
            </ion-button>
            <ion-button (click)="navigateSearch('up')">
              <ion-icon name="arrow-up-outline"></ion-icon>
            </ion-button>
            <ion-button (click)="navigateSearch('down')">
              <ion-icon name="arrow-down-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-item>
      </ng-template>

      <ion-buttons *ngIf="!showSearchBar" slot="end" style="margin-top: 15px">
        <ion-button style="color: black">
          <ion-icon name="videocam-outline" style="font-size: 35px"></ion-icon>
        </ion-button>
        <ion-button (click)="goToCallingScreen()" style="color: black">
          <ion-icon name="call-outline" style="font-size: 28px"></ion-icon>
        </ion-button>
        <ion-button (click)="openOptions($event)" style="color: black">
          <ion-icon
            name="ellipsis-vertical-outline"
            style="font-size: 28px"
          ></ion-icon>
        </ion-button>
      </ion-buttons>
    </ng-template>
  </ion-toolbar>
</ion-header>

<!-- BLOCK BANNERS -->
<!-- <div *ngIf="chatType === 'private'">
  <div *ngIf="iBlocked" class="blocked-banner" style="padding:8px; text-align:center; background:#fff3f3; color:#b00020;">
    You have blocked {{ receiver_name }}. Messages won't be sent.
    <button ion-button (click)="unblockFromChat()" style="margin-left:8px; border:none; background:transparent; color: #0a66ff;">Unblock</button>
  </div>

  <div *ngIf="!iBlocked && theyBlocked" class="blocked-banner" style="padding:8px; text-align:center; background:#fff7e6; color:#b36b00;">
    You cannot send messages to {{ receiver_name }} — they have blocked you.
  </div>
</div> -->

<ion-content class="chat-background" [fullscreen]="true" [scrollEvents]="true">
  <!-- Pinned Message Banner (Alternative/Mobile View) -->
  <!-- <div
    *ngIf="pinnedMessage && pinnedMessageDetails && showMobilePinnedBanner"
    class="pinned-message-banner"
    (click)="scrollToPinnedMessage()"
  >
    <div class="pinned-content">
      <div class="pinned-header">
        <ion-icon name="pin" class="pin-icon"></ion-icon>
        <span class="pinned-text">Pinned Message</span>
        <ion-icon
          name="close"
          class="unpin-icon"
          (click)="unpinMessage(); $event.stopPropagation()"
        ></ion-icon>
      </div>
      <div class="pinned-message-preview">
        <span class="pinned-sender" *ngIf="chatType === 'group'"
          >{{ pinnedMessageDetails.sender_name }}:</span
        >

 
        <span
          *ngIf="pinnedMessageDetails.text && !pinnedMessageDetails.attachment"
          class="pinned-text-content"
        >
          {{ pinnedMessageDetails.text.length > 50 ? (pinnedMessageDetails.text
          | slice:0:50) + '...' : pinnedMessageDetails.text }}
        </span>


        <span *ngIf="pinnedMessageDetails.attachment" class="pinned-attachment">
          <ion-icon
            [name]="getAttachmentIcon(pinnedMessageDetails.attachment.type)"
          ></ion-icon>
          {{ getAttachmentPreview(pinnedMessageDetails.attachment) }}
        </span>
      </div>
    </div>
  </div> -->

  <div
    #scrollContainer
    class="chat-messages"
    style="padding: 10px 10px 10px 10px; overflow-y: auto; min-height: 100%"
  >
    <!-- System block/unblock bubbles (only visible to blocker) -->
    <div
      *ngIf="showBlockBubble"
      class="system-bubble-wrapper"
      style="display: flex; justify-content: center; margin: 10px 0"
    >
      <div class="system-bubble" (click)="unblockFromChat()">
        You blocked this contact. Tap to unblock.
      </div>
    </div>

    <div
      *ngIf="showUnblockBubble"
      class="system-bubble-wrapper"
      style="display: flex; justify-content: center; margin: 10px 0"
    >
      <div class="system-bubble system-bubble-success">
        You unblocked this contact.
      </div>
    </div>

    <ion-spinner
      name="dots"
      *ngIf="isLoadingMore"
      style="margin: 8px auto; display: block"
    ></ion-spinner>

    <div *ngFor="let group of groupedMessages">
      <div class="date-divider" [id]="'date-group-' + group.date">
        <div class="text-bg-white date-label">{{ group.date }}</div>
      </div>

      <ng-container *ngFor="let msg of group.messages">
        <div
          class="msg-row"
          [ngClass]="{
       'align-end': msg.sender_id === senderId,
       'align-start': msg.sender_id !== senderId,
       'selected': isSelected(msg),
       'pinned-message-highlight': pinnedMessage && pinnedMessage.messageId === msg.message_id
     }"
          *ngIf="!isMessageHiddenForUser(msg)"
          style="display: flex; flex-direction: column; margin: 5px 0"
          (touchstart)="startLongPress(msg)"
          (touchend)="cancelLongPress()"
          (touchmove)="cancelLongPress()"
          (click)="onMessageClick(msg)"
        >
          <!-- ===== MESSAGE BUBBLE ===== -->
          <div
            class="message-bubble"
            (click)="openAttachmentModal(msg)"
            [attr.data-msg-key]="msg.msgId"
            [class.my-message]="msg.isMe"
            [ngClass]="[
        msg.isMe ? 'sender-message' : 'receiver-message',
        msg.fadeOut ? 'fade-out' : ''
       ]"
          >
            <!-- Forwarded Label -->
            <div *ngIf="msg.isForwarded" class="forwarded-label">
              <ion-icon
                name="arrow-undo-outline"
                class="forwarded-icon"
              ></ion-icon>
              Forwarded
            </div>

            <!-- Group Sender Name -->
            <span
              *ngIf="chatType === 'group' && msg.sender_id !== senderId"
              style="font-size: 12px; color: #6c6c6c; margin-left: 5px"
            >
              {{ msg.sender_name }}
            </span>

            <!-- Replied Message -->
            <div
              class="replied-message"
              *ngIf="msg.replyToMsgId"
              (click)="scrollToRepliedMessage(msg.replyToMsgId)"
            >
              <ng-container
                *ngIf="getRepliedMessage(msg.replyToMsgId) as repliedMsg"
              >
                <div class="replied-container">
                  <div class="replied-header">
                    <ion-icon
                      name="arrow-undo-outline"
                      class="reply-icon"
                    ></ion-icon>
                    <span class="replied-sender">
                      {{ repliedMsg.isMe ? 'You' : (replyTo?.sender?.username ||
                      chatTitle || 'Unknown') }}
                    </span>
                  </div>

                  <div class="replied-content">
                    <!-- Show text if available -->
                    <div class="replied-text" *ngIf="repliedMsg.text">
                      {{ getReplyPreviewText(repliedMsg) }}
                    </div>

                    <!-- Show attachment preview if no text but has attachment -->
                    <div
                      class="replied-attachment"
                      *ngIf="!repliedMsg.text && repliedMsg.attachment"
                    >
                      <ion-icon
                        [name]="getAttachmentIcon(repliedMsg.attachment.type)"
                      ></ion-icon>
                      {{ getReplyPreviewText(repliedMsg) }}
                    </div>
                  </div>
                </div>
              </ng-container>
            </div>

          <!-- Normal Message -->
<ng-container *ngIf="!msg.isDeleted">

  <!-- If no attachment and has text -->
  <ng-container *ngIf="!msg.attachment && msg.text">

    <!-- TRANSLATION BAR (if translations exist) -->
    <div class="translation-bar" *ngIf="msg.translations" (click)="$event.stopPropagation()">
      <div class="translation-label">
        <small *ngIf="getActiveTranslationLabel(msg) as activeLabel">
          {{ activeLabel }}
        </small>
        <small *ngIf="!getActiveTranslationLabel(msg)">Original</small>
      </div>

      <div class="translation-actions">
        <!-- Cycle translations -->
        <button
          class="btn-ghost"
          (click)="cycleTranslation(msg); $event.stopPropagation()"
          title="Switch translation"
          aria-label="Switch translation"
        >
          ↺
        </button>

        <!-- Popover/menu trigger (fallback to simple inline menu for compatibility) -->
        <!-- <button
          class="btn-ghost"
          (click)="openTranslationMenu(msg); $event.stopPropagation()"
          title="Choose translation"
          aria-label="Choose translation"
        >
          ⋯
        </button> -->

        <!-- Toggle show all translations -->
        <button
          class="btn-ghost"
          (click)="toggleShowAllTranslations(msg); $event.stopPropagation()"
          [attr.aria-pressed]="isShowingAllTranslations(msg)"
          title="Show all translations"
        >
          ☰
        </button>
      </div>
    </div>

    <!-- VISIBLE TEXT (either active translation or original) -->
    <ion-text class="message-text" (click)="$event.stopPropagation()">
      {{ getDisplayedText(msg) }}
      <span *ngIf="isTranslationLabelled(msg) && !isShowingAllTranslations(msg)"
            style="color: gray; font-size: 11px; margin-left:6px;">
        ({{ getActiveTranslationShortCode(msg) }})
      </span>
    </ion-text>

    <!-- ALL TRANSLATIONS EXPANDED -->
    <div class="all-translations" *ngIf="isShowingAllTranslations(msg)">
      <div class="translation-row" *ngFor="let t of getAllTranslationsArray(msg)">
        <div class="meta">
          <div class="lbl">{{ t.label }}</div>
          <div class="code">{{ t.code }}</div>
        </div>
        <div class="txt">{{ t.text }}</div>
        <div class="actions">
          <button class="btn-small" (click)="setActiveTranslation(msg, t.code); $event.stopPropagation()">Use</button>
          <button class="btn-small" (click)="copyToClipboard(t.text); $event.stopPropagation()">Copy</button>
        </div>
      </div>
    </div>

  </ng-container>

  <!-- Attachments (keep existing attachment markup unchanged) -->
  <ng-container *ngIf="msg.attachment">
    <!-- existing attachment markup — keep as before -->
    <img
      *ngIf="msg.attachment.type === 'image'"
      [src]="msg.attachment.previewUrl"
      alt="Image"
      style="max-width: 200px; border-radius: 10px; margin: 5px 0"
    />
    <video
      *ngIf="msg.attachment.type === 'video'"
      controls
      style="max-width: 200px; border-radius: 10px; margin: 5px 0"
    >
      <source
        [src]="msg.attachment.previewUrl"
        [type]="msg.attachment.mimeType || 'video/mp4'"
      />
    </video>
    <audio
      *ngIf="msg.attachment.type === 'audio'"
      controls
      style="margin: 5px 0"
    >
      <source
        [src]="msg.attachment.previewUrl"
        [type]="msg.attachment.mimeType || 'audio/mpeg'"
      />
    </audio>
    <div *ngIf="msg.attachment.type === 'file'" style="margin: 5px 0">
      <ion-icon name="document-outline" style="margin-right: 5px"></ion-icon>
      <a
        [href]="msg.attachment.previewUrl"
        [download]="msg.attachment.fileName || 'file'"
        target="_blank"
        rel="noopener"
      >
        {{ msg.attachment.fileName || 'Download File' }}
      </a>
    </div>

    <ion-text class="message-text" *ngIf="msg.text" style="margin-top: 5px">
      {{ msg.text }}
    </ion-text>
  </ng-container>

</ng-container>


            <!-- Timestamp -->
            <p class="time-stamp status-container">
              <ion-icon
                *ngIf="msg.isPinned"
                name="pin"
                class="pin-indicator-timestamp"
              ></ion-icon>
              {{ msg.time }}
              <span
                *ngIf="msg.isEdit"
                style="font-size: 11px; color: gray; margin-left: 4px"
                >(edited)</span
              >
              <ng-container
                *ngIf="getStatusIconDescriptorByMsgId(msg.msgId) as icon"
              >
                <ion-icon
                  [name]="icon.name"
                  [ngClass]="icon.cls"
                  [attr.title]="icon.title"
                ></ion-icon>
              </ng-container>
            </p>

            <!-- 🟡 COMPACT REACTION BADGE (WhatsApp style) -->
            <div
              class="reaction-badges"
              *ngIf="getReactionBadges(msg).length > 0"
              [class.right]="msg.sender_id === senderId"
              [class.left]="msg.sender_id !== senderId"
            >
              <!-- <div class="badge"
           *ngFor="let b of getReactionBadges(msg)"
           [class.mine]="b.mine"
           (click)="addReaction(msg, b.emoji)">
        <span class="emoji">{{ b.emoji }}</span>
        <span class="cnt" *ngIf="b.count > 1">{{ b.count }}</span>
      </div> -->
              <div
                class="badge"
                *ngFor="let b of msg.reactions"
                [class.mine]="b.userId == senderId"
                (click)="onReactionBadgeClick($event, msg, b)"
              >
                <span class="emoji">{{ b.emoji }}</span>
                <span class="cnt" *ngIf="getReactionsCount(msg)>1">
                  {{ getReactionsCount(msg) }}
                </span>
              </div>
            </div>
          </div>

          <!-- 🟢 FLOATING REACTION BAR -->
          <div
            class="reaction-bar"
            *ngIf="isQuickReactionOpen(msg)"
            [class.right]="msg.sender_id === senderId"
            [class.left]="msg.sender_id !== senderId"
          >
            <button class="react-btn" (click)="addReaction(msg, '👍')">
              👍
            </button>
            <button class="react-btn" (click)="addReaction(msg, '❤️')">
              ❤️
            </button>
            <button class="react-btn" (click)="addReaction(msg, '😂')">
              😂
            </button>
            <button class="react-btn" (click)="addReaction(msg, '😮')">
              😮
            </button>
            <button class="react-btn" (click)="addReaction(msg, '😢')">
              😢
            </button>
            <button class="react-btn" (click)="addReaction(msg, '🙏')">
              🙏
            </button>
            <button class="react-btn more" (click)="openEmojiKeyboard(msg)">
              ＋
            </button>
            <!-- <h2> Reaction emojis here</h2> -->
          </div>
        </div>
      </ng-container>
    </div>
  </div>
</ion-content>

<ion-modal [isOpen]="showPreviewModal" (didDismiss)="showPreviewModal = false">
  <ng-template>
    <ion-header [translucent]="true" class="model-header">
      <ion-toolbar class="model-toll">
        <ion-buttons slot="start">
          <!-- <ion-button (click)="cancelAttachment()">Cancel</ion-button> -->
          <ion-icon
            (click)="cancelAttachment()"
            name="close"
            style="font-size: 25px"
          ></ion-icon>
        </ion-buttons>

        <ion-buttons slot="end" class="pre-icons">
          <img src="assets/images/hd.png" alt="hd" />
          <ion-icon name="happy-outline" style="font-size: 24px"></ion-icon>
          <img src="assets/images/text.png" alt="text" />
          <img src="assets/images/pencil.png" alt="pencil" />
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="">
      <div class="pre-model">
        <div class="mine2">
          <div *ngIf="selectedAttachment?.type === 'image'">
            <img [src]="selectedAttachment?.previewUrl" class="preview-image" />
          </div>

          <div *ngIf="selectedAttachment?.type === 'video'">
            <video
              controls
              [src]="selectedAttachment?.previewUrl"
              class="preview-video"
            ></video>
          </div>

          <div *ngIf="selectedAttachment?.type === 'file'" class="preview-file">
            <ion-icon
              name="document-attach-outline"
              style="font-size: 48px"
            ></ion-icon>
            <p>{{ selectedAttachment?.fileName }}</p>
          </div>
        </div>

        <div class="mine ion-padding">
          <ion-textarea
            [(ngModel)]="messageText"
            placeholder="Type your message here..."
            class="pre-message"
          ></ion-textarea>

          <div class="sendbtn">
            <p>{{ receiver_name }}</p>
            <!-- <ion-icon
              name="send-outline"
              (click)="sendMessage()"
              class="mediasend"
            ></ion-icon> -->

            <ion-icon
              name="send-outline"
              (click)="sendMessage()"
              class="mediasend"
              [class.sending]="isSending"
              [style.pointer-events]="isSending ? 'none' : 'auto'"
              [style.opacity]="isSending ? '0.5' : '1'"
            >
            </ion-icon>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- ✅ Message Input Footer -->
<!-- ========================= -->
<!-- Message Input Footer (updated) -->
<div class="footer-fixed">
  <!-- Normal footer: typing indicator, reply preview, input row -->
  <div *ngIf="!iBlocked">
    <!-- ✅ UPDATED: Typing indicator (above keyboard) -->
    <div
      class="typing-indicator-wrapper"
      *ngIf="isReceiverTyping || typingCount > 0"
    >
      <!-- PRIVATE CHAT layout -->
      <div
        *ngIf="currentConv?.type === 'private' && isReceiverTyping"
        class="typing-indicator-content private"
      >
        <div
          class="typing-dots center-only"
          aria-hidden="true"
          role="status"
          aria-label="typing"
        >
          <span class="dot"></span><span class="dot"></span
          ><span class="dot"></span>
        </div>
      </div>

      <!-- GROUP CHAT layout -->
      <div
        *ngIf="currentConv?.type === 'group' && typingCount > 0"
        class="typing-indicator-content group"
      >
        <div class="typing-text">
          <div class="typing-avatars">
            <!-- Single user typing -->
            <ng-container *ngIf="typingCount === 1 && typingUsers.length >= 1">
              <img
                class="typing-avatar single"
                [src]="typingUsers[0].avatar || 'assets/images/default-avatar.png'"
                (error)="setDefaultAvatar($event)"
                [alt]="typingUsers[0].name || 'User'"
              />
            </ng-container>

            <!-- Multiple users typing -->
            <ng-container *ngIf="typingCount >= 2">
              <div class="avatar-stack">
                <img
                  *ngFor="let u of typingUsers.slice(0,3); let i = index"
                  class="typing-avatar stacked idx-{{i}}"
                  [src]="u.avatar || 'assets/images/default-avatar.png'"
                  (error)="setDefaultAvatar($event)"
                  [alt]="u.name || 'User'"
                />
                <div class="more-badge" *ngIf="typingCount > 3">
                  +{{ typingCount - 3 }}
                </div>
              </div>
            </ng-container>
          </div>
        </div>

        <div
          class="typing-dots"
          aria-hidden="true"
          role="status"
          aria-label="typing"
        >
          <span class="dot"></span><span class="dot"></span
          ><span class="dot"></span>
        </div>
      </div>
    </div>
    <!-- ========================= -->

    <!-- REPLY PREVIEW -->
    <div class="reply-preview" *ngIf="replyToMessage">
      <div class="reply-header">
        <span class="reply-to-text"
          >Replying to {{ replyTo?.sender?.username || "You"}}</span
        >
        <ion-button fill="clear" size="small" (click)="cancelReply()">
          <ion-icon name="close" slot="icon-only"></ion-icon>
        </ion-button>
      </div>
      <div class="reply-content">
        <div class="reply-line"></div>
        <div class="reply-message">
          {{ getReplyPreviewText(replyToMessage) }}
        </div>
      </div>
    </div>

<!-- INPUT ROW -->
<!-- INPUT ROW -->
<ion-row class="footer-row" style="align-items: center">
  <ion-col
    class="message-input-container"
    style="display: flex; flex-direction: column; align-items: stretch; gap: 8px"
  >
    <div style="display: flex; align-items: center; gap: 8px">
      <ion-icon
        name="document-text-outline"
        class="icon-left"
        (click)="openKeyboard()"
      ></ion-icon>

      <ion-textarea
        [disabled]="iBlocked"
        [autoGrow]="true"
        [(ngModel)]="messageText"
        placeholder="Message"
        (ionInput)="onMessageInput($event)"
        (ionFocus)="onInputFocus()"
        (ionBlur)="onInputBlur()"
        (keyup.enter)="sendMessage()"
        class="message-input"
      ></ion-textarea>

      <ion-icon
        name="attach-outline"
        (click)="pickAttachment()"
        class="icon-right"
        [hidden]="iBlocked"
      ></ion-icon>
      <ion-icon
        name="camera-outline"
        class="icon-right"
        (click)="openCamera()"
        [hidden]="iBlocked"
      ></ion-icon>
    </div>

    <!-- 🌐 Translation Options -->
    <div
      *ngIf="showTranslationOptions"
      class="translation-options"
      style="
        display: flex;
        justify-content: space-between;
        background: #f5f5f5;
        border-radius: 12px;
        padding: 6px 10px;
        margin-top: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        gap: 8px;
      "
    >
      <ion-button
        size="small"
        fill="outline"
        color="medium"
        (click)="translateTo('my')"
        [disabled]="isTranslatingToMy || isTranslatingToReceiver"
      >
        <ion-spinner 
          *ngIf="isTranslatingToMy" 
          name="crescent" 
          slot="start"
          style="width: 14px; height: 14px;"
        ></ion-spinner>
        <span *ngIf="!isTranslatingToMy">
          Translate to My Language ({{ myLangLabel }})
        </span>
        <span *ngIf="isTranslatingToMy">
          Translating...
        </span>
      </ion-button>

      <ion-button
        size="small"
        fill="outline"
        color="medium"
        (click)="translateTo('receiver')"
        [disabled]="isTranslatingToMy || isTranslatingToReceiver"
      >
        <ion-spinner 
          *ngIf="isTranslatingToReceiver" 
          name="crescent" 
          slot="start"
          style="width: 14px; height: 14px;"
        ></ion-spinner>
        <span *ngIf="!isTranslatingToReceiver">
          Translate to Receiver ({{ receiverLangLabel }})
        </span>
        <span *ngIf="isTranslatingToReceiver">
          Translating...
        </span>
      </ion-button>
    </div>

    <!-- 🌐 TRANSLATION CARD (MATCHING STYLE) -->
    <div
      *ngIf="translationCard?.visible"
      class="translation-ready-card"
      role="region"
      aria-label="Translation preview"
    >
      <!-- CARD HEADER -->
      <div class="card-head">
        <div class="title">Translation Ready</div>
        <div class="ts">
          {{ translationCard?.createdAt | date: 'shortTime' }}
        </div>
      </div>

      <!-- CARD BODY -->
      <div class="card-body">
        <div
          class="translation-row"
          *ngFor="let t of (translationCard?.items || [])"
        >
          <div class="meta">
            <div class="lbl">{{ t.label }}</div>
            <div class="code">{{ t.code }}</div>
          </div>
          <div class="txt" [attr.title]="t.text">
            {{ t.text }}
          </div>
        </div>

        <!-- EMPTY STATE -->
        <div
          *ngIf="!(translationCard?.items?.length)"
          class="no-items"
        >
          (No translations available)
        </div>
      </div>

      <!-- CARD ACTIONS -->
      <div class="card-actions">
        <ion-button 
          size="small" 
          fill="outline" 
          (click)="closeTranslationCard()"
        >
          Cancel
        </ion-button>
        <ion-button 
          size="small" 
          color="primary" 
          (click)="sendFromTranslationCard()"
        >
          Send Translated
        </ion-button>
      </div>
    </div>

  </ion-col>

  <ion-col size="auto" style="display: flex; align-items: center">
    <ion-button
      *ngIf="!showSendButton"
      class="mic-button"
      shape="round"
      [disabled]="iBlocked"
    >
      <ion-icon slot="icon-only" name="mic"></ion-icon>
    </ion-button>

    <ion-button
      *ngIf="showSendButton"
      fill="clear"
      class="send-btn"
      shape="round"
      (click)="sendMessage()"
      [disabled]="iBlocked"
    >
      <ion-icon slot="icon-only" name="send"></ion-icon>
    </ion-button>
  </ion-col>
</ion-row>
  </div>
</div>
<!-- ========================= -->

<ion-popover
  [isOpen]="showPopover"
  [event]="popoverEvent"
  (didDismiss)="showPopover = false"
  style="--width: 300px; --height: 400px"
>
  <ng-template>
    <ion-datetime
      presentation="date"
      (ionChange)="onDateSelected($event)"
      [value]="selectedDate"
      showDefaultButtons="true"
    ></ion-datetime>
  </ng-template>
</ion-popover>
