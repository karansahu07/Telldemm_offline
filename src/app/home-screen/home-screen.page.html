<ion-header [translucent]="true">
  <!-- ✅ Selection Mode Header -->
  <ion-toolbar *ngIf="isSelectionMode; else normalHomeHeader">
    <ion-buttons slot="start">
      <ion-button (click)="clearChatSelection()">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>

    <ion-title>{{ selectedChats.length }}</ion-title>

    <ion-buttons slot="end">
      <!-- Single pinned user -->
      <ng-container *ngIf="selectionMeta.isSinglePinned">
        <ion-button (click)="onUnpinSelected()">
          <ion-icon name="pin"></ion-icon>
        </ion-button>
        <ion-button (click)="onDeleteSelected()">
          <ion-icon name="trash-outline"></ion-icon>
        </ion-button>
        <ion-button (click)="onArchievedSelected()">
          <ion-icon name="download-outline"></ion-icon>
        </ion-button>
        <ion-button (click)="onMoreSelected($event)">
          <ion-icon name="ellipsis-vertical-outline"></ion-icon>
        </ion-button>
      </ng-container>

      <!-- Single user (regular) -->
      <ng-container *ngIf="selectionMeta.isSingleUser">
        <ion-button (click)="onPinSelected()">
          <ion-icon name="pin-outline"></ion-icon>
        </ion-button>
        <ion-button (click)="onDeleteSelected()">
          <ion-icon name="trash-outline"></ion-icon>
        </ion-button>
        <ion-button (click)="onMuteSelected()">
          <ion-icon name="notifications-off-outline"></ion-icon>
        </ion-button>
        <ion-button (click)="onArchievedSelected()">
          <ion-icon name="download-outline"></ion-icon>
        </ion-button>
        <ion-button (click)="onMoreSelected($event)">
          <ion-icon name="ellipsis-vertical-outline"></ion-icon>
        </ion-button>
      </ng-container>

      <!-- Multiple users only -->
      <ng-container *ngIf="selectionMeta.isMultiUsersOnly">
        <ion-button (click)="onPinSelected()">
          <ion-icon name="pin-outline"></ion-icon>
        </ion-button>
        <ion-button (click)="onDeleteSelected()">
          <ion-icon name="trash-outline"></ion-icon>
        </ion-button>
        <ion-button (click)="onArchievedSelected()">
          <ion-icon name="download-outline"></ion-icon>
        </ion-button>
        <ion-button (click)="onMoreSelected($event)">
          <ion-icon name="ellipsis-vertical-outline"></ion-icon>
        </ion-button>
      </ng-container>

      <!-- Includes any group (no delete/mute) -->
      <ng-container
        *ngIf="selectionMeta.includesGroup && !selectionMeta.includesCommunity"
      >
        <ion-button (click)="onPinSelected()">
          <ion-icon name="pin-outline"></ion-icon>
        </ion-button>
        <ion-button (click)="onMuteSelected()">
          <ion-icon name="notifications-off-outline"></ion-icon>
        </ion-button>
        <ion-button (click)="onArchievedSelected()">
          <ion-icon name="download-outline"></ion-icon>
        </ion-button>
        <ion-button (click)="onMoreSelected($event)">
          <ion-icon name="ellipsis-vertical-outline"></ion-icon>
        </ion-button>
      </ng-container>

      <!-- Any community selected -->
      <ng-container *ngIf="selectionMeta.includesCommunity">
        <ion-button (click)="onPinSelected()">
          <ion-icon name="pin-outline"></ion-icon>
        </ion-button>
        <ion-button (click)="onArchievedSelected()">
          <ion-icon name="download-outline"></ion-icon>
        </ion-button>
        <ion-button (click)="onMoreSelected($event)">
          <ion-icon name="ellipsis-vertical-outline"></ion-icon>
        </ion-button>
      </ng-container>
    </ion-buttons>
  </ion-toolbar>

  <!-- 🔁 Normal header -->
  <ng-template #normalHomeHeader>
    <ion-toolbar class="telldemm">
      <ion-title>
        <img src="assets/images/TELLDEMM.svg" alt="Logo" />
      </ion-title>

      <ion-buttons slot="end">
        <ion-button
          (click)="scanBarcode()"
          [attr.aria-label]="'home.actions.scan' | translate"
        >
          <img src="assets/images/qr-code.svg" alt="" />
        </ion-button>

        <ion-button
          (click)="openCamera()"
          [attr.aria-label]="'home.actions.camera' | translate"
        >
          <img src="assets/images/camera.svg" alt="" />
        </ion-button>

        <ion-button
          (click)="presentPopover($event)"
          [attr.aria-label]="'home.actions.menu' | translate"
        >
          <img src="assets/images/dots (1).svg" alt="" />
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
  </ng-template>

  <!-- 🔎 Search + filters row
       - normal mode: interactive
       - selection mode: visible but disabled
  -->
  <ion-toolbar>
    <div
      class="main-header"
      [class.disabled-ui]="isSelectionMode"
      [style.opacity]="isSelectionMode ? 0.55 : 1"
    >
      <div class="container">
        <input
          type="text"
          id="searchInput"
          [(ngModel)]="searchText"
          [placeholder]="'home.search.placeholder' | translate"
          [attr.aria-label]="'home.search.placeholder' | translate"
          [readonly]="isSelectionMode"
          [disabled]="isSelectionMode"
        />
      </div>
    </div>

    <div
      class="main-filters"
      [class.disabled-ui]="isSelectionMode"
      [style.opacity]="isSelectionMode ? 0.55 : 1"
    >
      <div class="filters">
        <button
          class="filter-link"
          [ngClass]="{ 'active-filter': selectedFilter === 'all' }"
          (click)="!isSelectionMode && setFilter('all')"
          [disabled]="isSelectionMode"
        >
          {{ 'home.filters.all' | translate }}
        </button>

        <button
          class="filter-link"
          [ngClass]="{ 'active-filter': selectedFilter === 'read' }"
          (click)="!isSelectionMode && setFilter('read')"
          [disabled]="isSelectionMode"
        >
          {{ 'home.filters.read' | translate }}
        </button>

        <button
          class="filter-link"
          [ngClass]="{ 'active-filter': selectedFilter === 'unread' }"
          (click)="!isSelectionMode && setFilter('unread')"
          [disabled]="isSelectionMode"
        >
          {{ 'home.filters.unread' | translate }}
        </button>

        <button
          class="filter-link"
          [ngClass]="{ 'active-filter': selectedFilter === 'groups' }"
          (click)="!isSelectionMode && setFilter('groups')"
          [disabled]="isSelectionMode"
        >
          {{ 'home.filters.groups' | translate }}
        </button>
      </div>
    </div>

    <!-- (optional) you can keep your group-creator here unchanged -->
    <div *ngIf="toggleGroupCreator" class="group-creator">
      <ion-input
        [(ngModel)]="newGroupName"
        [placeholder]="'home.groupCreator.placeholder' | translate"
      >
      </ion-input>
      <ion-list>
        <ng-container *ngFor="let user of chatList">
          <ion-item *ngIf="!user.group">
            <ion-label>{{ user.name }}</ion-label>
            <ion-checkbox [(ngModel)]="user.selected"></ion-checkbox>
          </ion-item>
        </ng-container>
      </ion-list>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Loader skeleton -->
  <ion-list *ngIf="isLoading" aria-busy="true" aria-live="polite">
    <ion-item *ngFor="let i of [1,2,3,4,5,6,7,8,9]">
      <ion-avatar slot="start">
        <ion-skeleton-text
          animated
          style="width: 40px; height: 40px; border-radius: 50%"
        ></ion-skeleton-text>
      </ion-avatar>
      <ion-label>
        <h3>
          <ion-skeleton-text animated style="width: 60%"></ion-skeleton-text>
        </h3>
        <p>
          <ion-skeleton-text animated style="width: 80%"></ion-skeleton-text>
        </p>
      </ion-label>
    </ion-item>
  </ion-list>

  <!-- Meta rows: Locked & Archived -->
  <ion-list
    *ngIf="!isLoading && (lockedCount > 0 || archievedCount > 0)"
    lines="none"
    class="meta-list"
  >
    <ion-item
      *ngIf="lockedCount > 0"
      button
      detail="true"
      (click)="openLockedChats()"
    >
      <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
      <ion-label>Locked chats</ion-label>
      <ion-badge slot="end" color="medium">{{ lockedCount }}</ion-badge>
    </ion-item>

    <ion-item
      *ngIf="archievedCount > 0"
      button
      detail="true"
      (click)="openArchived()"
    >
      <ion-icon name="archive-outline" slot="start"></ion-icon>
      <ion-label>Archived</ion-label>
      <ion-badge slot="end" color="medium">{{ archievedCount }}</ion-badge>
    </ion-item>
  </ion-list>

  <ion-list *ngIf="!isLoading">
    <ion-item
      *ngFor="let chat of conversations"
      [class.selected]="chat.isSelected"
      [class.archived]="chat.isArchived"
      (click)="onChatRowClick(chat, $event)"
      (touchstart)="startHomeLongPress(chat)"
      (touchend)="cancelHomeLongPress()"
      (touchmove)="cancelHomeLongPress()"
      [class.selected]="isChatSelected(chat)"
    >
      <!-- ✅ Selection tick when in selection mode -->
      <!-- <div
        slot="start"
        class="select-tick"
        *ngIf="selectedChats.length > 0"
        (click)="toggleChatSelection(chat, $event)"
      >
        <ion-icon
          [name]="chat.isSelected ? 'checkmark-circle' : 'ellipse-outline'"
        ></ion-icon>
      </div> -->
      <ion-checkbox
        *ngIf="hasSelection"
        slot="start"
        [checked]="isConvSelected(chat.roomId)"
        (ionChange)="toggleChatSelection(chat, $event)"
      >
      </ion-checkbox>

      <!-- ✅ Avatar / Image -->
      <ion-avatar
        slot="start"
        (click)="
      selectedChats.length
        ? toggleChatSelection(chat, $event)
        : openImagePopup(getChatAvatarUrl(chat) || 'assets/images/user.jfif');
      $event.stopPropagation()
    "
      >
        <ng-container *ngIf="chat.avatar; else initialsTpl">
          <img
            [src]="chat.avatar"
            [alt]="getChatAlt(chat)"
            (error)="onAvatarError(chat)"
          />
        </ng-container>
        <ng-template #initialsTpl>
          <div class="avatar">{{ chat.title?.charAt(0) }}</div>
        </ng-template>
      </ion-avatar>

      <ion-label>
        <p
          class="chat-message"
          style="
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 4px;
          "
        >
          {{ chat.title }}
          <!-- Pin icon for pinned chats -->
          <ion-icon
            *ngIf="chat.isPinned"
            name="pin"
            style="margin-left: 6px; opacity: 0.7"
          ></ion-icon>

          <!-- Archive badge -->
          <ion-badge
            *ngIf="chat.isArchived"
            (onclick)="onArchievedSelected()"
            color="medium"
            style="margin-left: 4px; font-size: 10px"
          >
            Archived
          </ion-badge>
        </p>

        <!-- Message or typing indicator -->
        <p
          [ngClass]="{ 'typing-text': chat.isTyping }"
          style="margin: 0; display: flex; align-items: center; gap: 6px"
        >
          <ng-container *ngIf="chat.isTyping; else justMessage">
            <span style="font-weight: 600; color: #666">{{ chat.title }}</span>
            <ion-icon
              name="caret-forward-outline"
              style="font-size: 10px; color: #999"
            ></ion-icon>
            <span
              style="
                color: #666;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
              "
            >
              {{ getPreviewText(chat) }}
            </span>
          </ng-container>

          <ng-template #justMessage>
            <ng-container [ngSwitch]="chat.isTyping">
              <span *ngSwitchCase="true" style="color: #666"> ...Typing </span>
              <span
                *ngSwitchDefault
                style="
                  color: #666;
                  white-space: nowrap;
                  overflow: hidden;
                  text-overflow: ellipsis;
                "
              >
                &nbsp;{{ getPreviewText(chat) }}
              </span>
            </ng-container>
          </ng-template>
        </p>
      </ion-label>

      <div slot="end" class="chat-meta">
        <p class="time">
          {{ chat?.lastMessageAt ? (chat.lastMessageAt | date: 'shortTime') : ''
          }}
        </p>

        <ion-badge
          *ngIf="(+ (chat?.unreadCount ?? 0)) > 0"
          color="danger"
          class="unread-badge"
        >
          {{ chat.unreadCount }}
        </ion-badge>

        <ion-icon
          *ngIf="chat.type==='community'"
          name="chevron-forward-outline"
          style="color: #bdbdbd; margin-left: 8px"
        ></ion-icon>
      </div>
    </ion-item>
  </ion-list>

  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <div
      class="icon-image"
      (click)="goToContact()"
      [attr.aria-label]="'home.actions.contacts' | translate"
    >
      <img src="assets/images/user.svg" alt="" />
    </div>
  </ion-fab>

  <!-- Image Popup Modal -->
  <ion-modal
    [isOpen]="showPopup"
    (didDismiss)="closeImagePopup()"
    [backdropDismiss]="true"
    cssClass="custom-blur-modal"
  >
    <ng-template>
      <div class="popup-container">
        <img
          [src]="selectedImage"
          [alt]="'home.alt.profile' | translate"
          class="popup-image"
        />
        <div class="icon-row">
          <ion-icon
            name="chatbox-ellipses-outline"
            class="popup-icon"
            (click)="goToUserchat()"
          ></ion-icon>
          <ion-icon
            name="call-outline"
            class="popup-icon"
            (click)="goToUsercall()"
          ></ion-icon>
          <ion-icon
            name="videocam-outline"
            class="popup-icon"
            (click)="goToUservideocall()"
          ></ion-icon>
          <ion-icon
            name="alert-circle-outline"
            class="popup-icon"
            (click)="goToUserAbout()"
          ></ion-icon>
        </div>
      </div>
    </ng-template>
  </ion-modal>
</ion-content>

<app-footer-tabs [totalUnreadCount]="totalUnreadCount"></app-footer-tabs>
