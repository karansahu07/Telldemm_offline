<ion-header [translucent]="true" [class.scrolled]="isScrolled">

  <ion-toolbar style="padding-top: 30px;">

    <ion-button slot="start" fill="clear" (click)="goBackToChat()" class="backbutton">
      <ion-icon name="arrow-back-outline" class="back-icon"></ion-icon>
    </ion-button>

    <ion-button slot="end" fill="clear" (click)="openMenu($event)" class="dotbutton">
      <ion-icon name="ellipsis-vertical" class="dot-icon"></ion-icon>
    </ion-button>

    <div class="profile-container">
      <!-- <ion-avatar class="profile-avatar" (click)="openProfileDp()">
        <img src="assets/images/user.jfif" alt="Profile Picture" />
      </ion-avatar> -->
      <ion-avatar class="profile-avatar" (click)="openProfileDp()">
  <img [src]="receiverProfile || 'assets/images/user.jfif'" 
       alt="Profile Picture" 
       (error)="setDefaultAvatar($event)" />
</ion-avatar>

      <ion-label class="profile-name"> {{ isGroup ? groupName : receiver_name }}</ion-label>
    </div>

  </ion-toolbar>

</ion-header>

<ion-content [[fullscreen]="true" (ionScroll)="onScroll($event)" scrollEvents="true">
  <div class="center-content">
    <ion-label class="username">
      {{ isGroup ? groupName : receiver_name }}
    </ion-label>

    <ion-label class="usernumber">
    {{ isGroup ? groupMembers.length + ' members' : receiver_phone }}
  </ion-label>
  </div>

  <!-- Social Media Links -->
<div class="social-links" *ngIf="socialMediaLinks.length > 0">
  <ion-list lines="none">
    <ion-item *ngFor="let link of socialMediaLinks" button detail="false" (click)="openExternalLink(link.profile_url)">
      <ion-icon [name]="link.platform.toLowerCase() === 'instagram' ? 'logo-instagram' 
                      : link.platform.toLowerCase() === 'linkedin' ? 'logo-linkedin'
                      : 'link-outline'" slot="start"></ion-icon>
      <ion-label>
        <h3>{{ link.platform }}</h3>
        <p>{{ link.profile_url }}</p>
      </ion-label>
    </ion-item>
  </ion-list>
</div>


  <!-- Common Message Toolbar -->
  <div class="message-toolbar" style="margin-top: 15px; margin-bottom: 15px;">
    <div class="message-item" *ngIf="chatType === 'private'" (click)="goBackToChat()">
      <ion-avatar class="centered-avatar">
        <ion-icon name="chatbox-ellipses-outline" class="mess-icon"></ion-icon>
      </ion-avatar>
      <ion-label>Message</ion-label>
    </div>

    <div class="message-item">
      <ion-avatar class="centered-avatar">
        <ion-icon name="call-outline" class="mess-icon"></ion-icon>
      </ion-avatar>
      <ion-label>Call</ion-label>
    </div>

    <div class="message-item">
      <ion-avatar class="centered-avatar">
        <ion-icon name="videocam-outline" class="mess-icon"></ion-icon>
      </ion-avatar>
      <ion-label>Video</ion-label>
    </div>

    <div class="message-item" *ngIf="chatType === 'group'" (click)="onAddMember()">
      <ion-avatar class="centered-avatar">
        <ion-icon name="person-add-outline" class="all-icon1"></ion-icon>
      </ion-avatar>
      <ion-label>Add</ion-label>
    </div>


  </div>

  <!-- Private Chat Static Message -->
  <!-- <div class="what-mess" *ngIf="chatType === 'private'">
    <p class="messgae-chat">Hey there! I am using WhatsApp.</p>
    <p class="message-number">23 March 2024</p>
  </div> -->

  <!-- PRIVATE CHAT DESCRIPTION -->
<!-- ✅ PRIVATE CHAT DESCRIPTION -->
<!-- Group / Private Description Block -->
<!-- <div class="what-mess" *ngIf="chatType === 'group' || chatType === 'private'">
  <p class="messgae-chat" *ngIf="chatType === 'private'">
    {{ receiverAbout || 'Hey there! I am using Telldemm.' }}
  </p>

  <ng-container *ngIf="chatType === 'group'">
  <p class="messgae-chat" (click)="openGroupDescriptionPage()">
    {{ groupDescription || 'No group description.' }}
  </p>
  <p class="message-number">
    Created by {{ groupCreatedBy || 'Unknown' }} on
    {{ groupCreatedAt ? (groupCreatedAt | date: 'dd MMMM yyyy, h:mm a') : 'Unknown Date' }}
  </p>
</ng-container>

</div> -->

<div class="what-mess" *ngIf="chatType === 'group' || chatType === 'private'">
  <!-- PRIVATE CHAT: show about + timestamp -->
  <ng-container *ngIf="chatType === 'private'">
    <p class="messgae-chat">
      {{ receiverAbout || 'Hey there! I am using Telldemm.' }}
    </p>

    <p class="status-time" *ngIf="statusTime">
      Updated on {{ statusTime | date:'dd MMM yyyy, h:mm a' }}
    </p>
  </ng-container>

  <!-- GROUP CHAT -->
  <ng-container *ngIf="chatType === 'group'">
    <p class="messgae-chat" (click)="openGroupDescriptionPage()">
      {{ groupDescription || 'No group description.' }}
    </p>
    <p class="message-number">
      Created by {{ groupCreatedBy || 'Unknown' }} on
      {{ groupCreatedAt ? (groupCreatedAt | date: 'dd MMMM yyyy, h:mm a') : 'Unknown Date' }}
    </p>
  </ng-container>
</div>




  <!-- Media Section (Common) -->
  <div class="main-media">
    <div class="all-media">
      <p class="docs">Media, Links, and docs</p>
      <div class="media-count">
        <ion-button fill="clear" routerLink="/" class="no-decoration">20</ion-button>
        <ion-icon name="chevron-forward-outline"></ion-icon>
      </div>
    </div>

    <!-- Swiper Gallery -->
    <swiper-container [attr.slides-per-view]="4" [attr.space-between]="10" class="slider">
      <swiper-slide *ngFor="let item of [].constructor(15)" class="slider-swip">
        <div class="image-wrapper">
          <img src="assets/images/user.jfif" alt="Rectangle-img" />
        </div>
      </swiper-slide>
    </swiper-container>
  </div>

  <!-- Notification Section (Common) -->
  <ion-list lines="none" class="noti-list">
    <ion-item>
      <ion-icon name="notifications-outline" slot="start" class="all-icon"></ion-icon>
      <ion-label class="Encry">Notifications</ion-label>
    </ion-item>

    <ion-item>
      <ion-icon name="image-outline" slot="start" class="all-icon"></ion-icon>
      <ion-label class="Encry">Media Visibility</ion-label>
    </ion-item>
  </ion-list>

  <!-- Encryption and Privacy Settings (Only for Private Chat) -->
  <ion-list lines="none" class="noti-list" *ngIf="chatType === 'private'">
    <ion-item class="jha">
      <ion-icon name="lock-closed-outline" slot="start" class="all-icon"></ion-icon>
      <ion-label>
        <div>
          <div class="Encry">Encryption</div>
          <div class="encrypted">Messages and calls are end-to-end encrypted. Tap to verify.</div>
        </div>
      </ion-label>
    </ion-item>

    <ion-item class="jha">
      <ion-icon name="timer-outline" slot="start" class="all-icon"></ion-icon>
      <ion-label class="Encry">Disappearing messages</ion-label>
    </ion-item>

    <ion-item class="jha">
      <ion-icon name="lock-closed-outline" slot="start" class="all-icon"></ion-icon>
      <ion-label>
        <div>
          <div class="Encry">Chat lock</div>
          <div class="encrypted">Lock and hide this chat on this device.</div>
        </div>
      </ion-label>
      <ion-icon name="toggle-outline" class="all-icon"></ion-icon>
    </ion-item>

    <ion-item class="jha">
      <ion-icon name="shield-half-outline" slot="start" class="all-icon"></ion-icon>
      <ion-label>
        <div>
          <div class="Encry">Advanced Chat Privacy</div>
          <div class="encrypted">Off</div>
        </div>
      </ion-label>
    </ion-item>
  </ion-list>

  <!-- private Info Section (Only for private Chat) -->
  <ion-list lines="none" class="noti-list" *ngIf="chatType === 'private'">
    <!-- <ion-label class="total-group">2 Groups in Common</ion-label> -->
    <ion-label class="total-group">
      {{ commonGroups.length }} Group{{ commonGroups.length > 1 ? 's' : '' }} in Common
    </ion-label>

    <ion-item class="jha" (click)="createGroupWithMember()">
      <ion-icon name="person-outline" class="all-icon" slot="start"></ion-icon>
      <ion-label class="Encry">Create group with {{ receiver_name }}</ion-label>
    </ion-item>


    <ion-item class="jha" *ngFor="let group of commonGroups">
      <ion-avatar slot="start">
        <img [src]="'assets/images/user.jfif'" />
      </ion-avatar>
      <ion-label>
        <div>
          <div class="Encry">{{ group.name || 'Unnamed Group' }}</div>
          <div class="encrypted">Common group with {{ receiver_name }}</div>
        </div>
      </ion-label>
    </ion-item>
  </ion-list>

  <!-- Group Members Section -->
  <ion-list *ngIf="chatType === 'group'" lines="none" class="noti-list">
    <ion-item>
      <ion-icon name="people-outline" slot="start" class="all-icon"></ion-icon>
      <ion-label class="Encry">
        Group Members ({{ groupMembers.length }})
      </ion-label>
    </ion-item>
    <ion-item>
      <ion-button fill="clear" slot="start" (click)="onAddMember()">
        <ion-icon name="person-add-outline" slot="start" class="all-icon1"></ion-icon>
      </ion-button>
      <ion-label class="Encry" (click)="onAddMember()">
        Add Members
      </ion-label>
    </ion-item>

    <ion-item *ngFor="let member of groupMembers" (click)="openActionSheet(member)">
      <ion-avatar slot="start">
        <img [src]="member.avatar || 'assets/images/user.jfif'" />
      </ion-avatar>

      <ion-label>
        <div class="Encry">
          {{ member.name }}
        </div>
        <!-- <div class="encrypted">{{ member.phone_number }}</div> -->
      </ion-label>

      <ion-badge *ngIf="member.role === 'admin'" class="admin-badge"
        style="margin-left: 6px;font-size: 10px;color: red; background-color: #FFD4D4;">
        admin
      </ion-badge>


      <!-- Show 3-dot menu ONLY if it's NOT the current user -->
      <!-- <ion-buttons slot="end" *ngIf="member.user_id !== currentUserId">
        <ion-button fill="clear" (click)="openActionSheet(member)">
          <ion-icon name="ellipsis-vertical"></ion-icon>
        </ion-button>
      </ion-buttons> -->
    </ion-item>


    <ion-item *ngIf="hasPastMembers">
  <ion-icon name="people-outline" slot="start" class="all-icon"></ion-icon>
  <ion-label class="Encry1" (click)="viewPastMembers()">View Past Members</ion-label>
</ion-item>


  </ion-list>

  <!-- User Management Options (Common) -->
  <ion-list lines="none" class="noti-list">

  <ion-item class="jha">
    <ion-icon name="heart-outline" slot="start" class="all-icon"></ion-icon>
    <ion-label class="Encry">Add to Favourites</ion-label>
  </ion-item>

  <ion-item class="jha">
    <ion-icon name="person-add-outline" slot="start" class="all-icon"></ion-icon>
    <ion-label class="Encry">Add to list</ion-label>
  </ion-item>

  <!-- ✅ Block / Unblock toggle (only private chat) -->
  <!-- <ion-item 
    class="jha" 
    *ngIf="chatType === 'private' && !isBlocked" 
    (click)="blockUser()">
    <ion-icon name="ban-outline" slot="start" class="all-icon"></ion-icon>
    <ion-label class="Encry">Block {{ receiver_name }}</ion-label>
  </ion-item>

  <ion-item 
    class="jha" 
    *ngIf="chatType === 'private' && isBlocked" 
    (click)="unblockUser()">
    <ion-icon name="checkmark-circle-outline" slot="start" class="all-icon"></ion-icon>
    <ion-label class="Encry">Unblock {{ receiver_name }}</ion-label>
  </ion-item> -->

  <ion-item 
  class="jha" 
  *ngIf="chatType === 'private' && !iBlocked" 
  (click)="blockUser()">
  <ion-icon name="ban-outline" slot="start" class="all-icon"></ion-icon>
  <ion-label class="Encry">Block {{ receiver_name }}</ion-label>
</ion-item>

<!-- Show "Unblock" when I have blocked them -->
<ion-item 
  class="jha" 
  *ngIf="chatType === 'private' && iBlocked" 
  (click)="unblockUser()">
  <ion-icon name="checkmark-circle-outline" slot="start" class="all-icon"></ion-icon>
  <ion-label class="Encry">Unblock {{ receiver_name }}</ion-label>
</ion-item>

<!-- optional: show info if *they have blocked me* -->
<!-- <ion-item *ngIf="chatType==='private' && theyBlocked" lines="none">
  <ion-icon name="warning-outline" slot="start"></ion-icon>
  <ion-label>
    This user has blocked you — you cannot send messages to them.
  </ion-label>
</ion-item> -->

  <!-- ✅ Report user/group (always visible) -->
  <ion-item class="jha" (click)="reportUser()">
    <ion-icon name="thumbs-down-outline" slot="start" class="all-icon"></ion-icon>
    <ion-label class="Encry">Report {{ isGroup ? groupName : receiver_name }}</ion-label>
  </ion-item>

</ion-list>
</ion-content>